import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from scipy.fft import dct, idct

def dct_smoothing(df:pd.DataFrame, column:str, max_val:int=10):

    df_values = df[column].values
    W = np.arange(0, df_values.shape[0])
    dct_values = dct(df_values)
    smoothed_signal = dct_values.copy()
    smoothed_signal[(W > max_val)] = 0

    return idct(smoothed_signal)

def line_plot(df:pd.DataFrame, column:str):
    fig = go.Figure()
    fig.add_trace(
        go.Scatter(
            x=df.hourutc,
            y=df[column].values,
            line={ "color":"grey"},
            fill="tonexty",
            # mode="none",
            opacity=0.5,
            name="Observed"
        ),
    )
    
    fig.add_trace(
        go.Scatter(
            x=df.hourutc,
            y=df["smoothed_signal"].values,
            line=dict(color="purple"),
            name="DCT-filtered",
        )
    )

    df_current_pos = df.iloc[-1, :]
    fig.add_trace(
        go.Scatter(x=[ df_current_pos.hourutc ], 
                   y=[ df_current_pos["smoothed_signal"] ],
                   mode="markers", marker=dict(color="red", size=7),
                   name="Current time point"
                   ),
    )

    fig.update_layout(legend=dict(
        orientation="h",
        yanchor="bottom",
        xanchor="right",
        y=1.02,
        x=1
    )
                      )
    return fig

def map_plot(df:pd.DataFrame, column:str, df_municipality:pd.DataFrame):

    df_sizes = df[column].iloc

    fig = go.Figure()
    fig.add_trace(
        go.Scattermap(
            lat=df_municipality.lat.values,
            lon=df_municipality.lon.values,
            hovertext=df_municipality.municipality,
            hovertemplate="%{hovertext}<br>" +
            "(%{lat:.5f}, %{lon:.5f})",
            name=None,
            # marker=dict(
            #     size=df_
            # ),
        )
    )
    fig.update_layout(
        map=dict(
            center=dict(
                lat=56.1865, 
                lon=11.5683
            ),
            zoom=5
        ),
        hoverlabel=dict(
            bgcolor="white",
            font_size=11,
        )
    )
    return fig

# Sidebar
st.sidebar.markdown("# Main page ðŸŽˆ")

# Main page content
# data_sources = {"Production": "production",
#                 "Consumption": "consumption",
#                 "Prodcons": "prodcons",
#                 "Weather": "weather"}

data_sources = {
    "Production": {
        "session_state": "production",
        "dropdown_title": "Production Type",
        # "municipality": True,
    },
    "Consumption": {
        "session_state": "consumption",
        "dropdown_title": "Industry Group",
        # "municipality": True,
    },
    "Power import/export": {
        "session_state": "prodcons",
        "dropdown_title": None,
        # "municipality": False,
    },
    "Weather": {
        "session_state": "weather",
        "dropdown_title": "Weather Property",
        # "municipality": True,
    },
}

top_col_1, top_col_2 = st.columns(spec=[0.65, 0.35])
with top_col_1:
    st.markdown("# Main page ðŸŽˆ")

with top_col_2:
    selected_table = st.selectbox(
        "Data source",
        options=["Weather", "Production", "Consumption", "Power import/export",],
        index=0,
    )

    if selected_table is not None:
        current_source = data_sources[selected_table]
        access_table = current_source["session_state"]
        df_table = st.session_state[access_table]
        print(f"The current data source is set to {selected_table}.")

    else:
        df_table = None
        print("No data source is currently set.")
        st.text("No data source is currently set.")


# if st.checkbox("Show dataframe"):
#     # st.table( df_mun ) # static DataFrame?
#     st.session_state["municipalities"]# Shows the DataFrame?

col_1, col_2 = st.columns(spec=[0.5, 0.5])
data_column = None

with col_1:
    # st.image(
    #     "https://freevector-images.s3.amazonaws.com/uploads/vector/preview/165256/vecteezy-CountryName_-WorldMap-RH0223_generated.jpg"
    # )
    df_mun = st.session_state["municipalities"]

    # df_current_date = df_table.loc[df_table.hourutc == date_time,
    #     :].sort_values("municipality")
    if df_table is not None:
        time_values = df_table.hourutc.unique()
        date_time = st.select_slider(
            label="Time slider", options=time_values, 
            value=pd.to_datetime("2022-06-01")
        )
        df_table = df_table.loc[df_table.hourutc <= date_time, :]

    
 
with col_2:
    col_21, col_22, col_23 = st.columns(spec=[0.4, 0.4, 0.2])
    # st.image(
    #     "https://owlcation.com/.image/c_fill,w_1200,h_675,g_faces:center/MTc0MTYyMTE1NzA2NDMwOTcy/how-to-draw-a-scientific-graph.gif"
    # )

    if df_table is not None:
        dropdown_title = current_source["dropdown_title"]
        municipality_list = sorted(df_table.municipality.unique().tolist())

        exclude_data_columns = ["id", "dist_to_station", "hourutc", "tsun", 
                            "municipality"
                            ]
        data_columns = [
            data_column
            for data_column in df_table.columns.tolist()
            if data_column not in exclude_data_columns
        ]

        with col_21:
            data_column = st.selectbox(
                dropdown_title, options=data_columns, index=1
            )
        with col_22:
            municipality = st.selectbox("Municipality",
                                        options=municipality_list)
        with col_23:
            max_val = st.number_input("DCT filtering", 0, 50, 10, 1)

        # st.text(f"{ data_column } + { municipality }")
        df_table = df_table[df_table.municipality ==
        municipality][["hourutc", "municipality", data_column]]

        smoothed_data = dct_smoothing(df_table, data_column, max_val=max_val)
        df_table["smoothed_signal"] = smoothed_data

        # Altair chart
        # st.line_chart(data=df_table, x="hourutc", y=data_column,
        #               width=500, height=400, x_label="Time of year")
        # st.line_chart(data=df_table, x="hourutc", y="smoothed_signal",
        #               width=500, height=400, x_label="Time of year")

        st.plotly_chart(line_plot(df_table, data_column))

with col_1:
    if data_column is not None:
        st.plotly_chart(map_plot(df_table, data_column, df_mun))
       
